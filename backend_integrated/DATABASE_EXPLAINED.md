# ğŸ“Š Database Architecture - MongoDB vs SQL

## ğŸ¯ Quick Answer

**No, we are NOT using SQL!**

We're using **MongoDB** (a NoSQL database), but Django was originally designed for SQL databases, so we use **djongo** as a translator.

---

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PresenceIQ Backend                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Django Models (Python Code)                                â”‚
â”‚  â†“                                                           â”‚
â”‚  Django ORM (Object-Relational Mapping)                     â”‚
â”‚  â†“                                                           â”‚
â”‚  SQL Queries (Generated by Django)                          â”‚
â”‚  â†“                                                           â”‚
â”‚  djongo (Translator Layer) â† WE USE THIS!                   â”‚
â”‚  â†“                                                           â”‚
â”‚  MongoDB Queries (NoSQL)                                     â”‚
â”‚  â†“                                                           â”‚
â”‚  MongoDB Database (Document Store)                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ How It Actually Works

### Example: Fetching Students

#### 1ï¸âƒ£ **You Write (Django ORM):**

```python
students = User.objects.filter(role='student', is_active=True)
```

#### 2ï¸âƒ£ **Django Generates (SQL):**

```sql
SELECT * FROM users
WHERE role = 'student'
AND is_active = TRUE;
```

#### 3ï¸âƒ£ **djongo Converts (MongoDB Query):**

```javascript
db.users.find({
	role: "student",
	is_active: true,
});
```

#### 4ï¸âƒ£ **MongoDB Returns (JSON Documents):**

```json
[
    {
        "_id": ObjectId("507f1f77bcf86cd799439011"),
        "email": "john@example.com",
        "first_name": "John",
        "role": "student",
        "is_active": true
    },
    {
        "_id": ObjectId("507f1f77bcf86cd799439012"),
        "email": "jane@example.com",
        "first_name": "Jane",
        "role": "student",
        "is_active": true
    }
]
```

---

## ğŸ“‹ Database Configuration

### Current Setup:

```python
DATABASES = {
    'default': {
        'ENGINE': 'djongo',           # â† MongoDB adapter for Django
        'NAME': 'presenceiq_final',   # â† Database name
        'CLIENT': {
            'host': 'localhost',       # â† MongoDB server
            'port': 27017,             # â† MongoDB default port
        }
    }
}
```

### Location:

-   **File:** `config/settings/base.py`
-   **Lines:** 82-107
-   **Database:** MongoDB running on `localhost:27017`
-   **Database Name:** `presenceiq_final`

---

## ğŸ†š MongoDB vs SQL: Key Differences

### SQL (Traditional - NOT USED):

```sql
-- Rigid Table Structure
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    role VARCHAR(20),
    created_at TIMESTAMP
);

-- Fixed Schema
INSERT INTO users VALUES (
    'uuid-here',
    'john@example.com',
    'John',
    'student',
    NOW()
);
```

### MongoDB (What We Use - USED):

```javascript
// Flexible Document Structure
db.users.insertOne({
	_id: ObjectId(),
	email: "john@example.com",
	first_name: "John",
	role: "student",
	created_at: ISODate(),
	// Can add extra fields anytime!
	hobbies: ["coding", "gaming"], // No schema change needed!
	metadata: {
		last_login: ISODate(),
		login_count: 42,
	},
});
```

---

## ğŸ“Š Collections in MongoDB

### What are Collections?

Collections in MongoDB = Tables in SQL

### Our Collections (in `presenceiq_final` database):

```javascript
// Authentication
users; // User accounts
auth_permission; // Django permissions
auth_group; // User groups

// Academic
departments; // Academic departments
subjects; // Course subjects
timetables; // Class schedules
holidays; // Academic holidays

// Attendance
class_sessions; // Individual classes
attendance_records; // Attendance marks
attendance_statistics; // Aggregated data
attendance_reports; // Generated reports

// Face Recognition
face_data; // Face encodings
face_images; // Uploaded images
recognition_logs; // Recognition attempts

// Core Django
django_migrations; // Migration history
django_session; // User sessions
django_admin_log; // Admin actions
django_content_type; // Content types
```

---

## ğŸ” View Your MongoDB Data

### Method 1: MongoDB Compass (GUI)

1. **Download:** https://www.mongodb.com/try/download/compass
2. **Connect:** `mongodb://localhost:27017`
3. **Select Database:** `presenceiq_final`
4. **Browse Collections:** Click any collection to see documents

### Method 2: mongosh (Command Line)

```bash
# Open MongoDB shell
mongosh

# Select database
use presenceiq_final

# Show all collections
show collections

# View users
db.users.find().pretty()

# Count documents
db.users.countDocuments()

# Find specific user
db.users.findOne({ email: "s0405verma@gmail.com" })

# Find all students
db.users.find({ role: "student" })

# View attendance records
db.attendance_records.find().limit(10)
```

### Method 3: Python Script

```python
import pymongo

# Connect to MongoDB
client = pymongo.MongoClient('localhost', 27017)
db = client['presenceiq_final']

# View collections
print("Collections:", db.list_collection_names())

# Get user count
user_count = db.users.count_documents({})
print(f"Total users: {user_count}")

# Find students
students = db.users.find({ "role": "student" })
for student in students:
    print(f"- {student['email']} ({student['first_name']})")
```

---

## â“ Why MongoDB Instead of SQL?

### Advantages for PresenceIQ:

#### 1. **Flexible Schema** ğŸ“

```javascript
// Can add new fields without migrations
db.users.updateOne(
	{ email: "john@example.com" },
	{ $set: { profile_picture_url: "http://..." } }
);
// No "ALTER TABLE" needed!
```

#### 2. **JSON-Native** ğŸ”„

```javascript
// Store complex nested data easily
{
    student_id: "12345",
    attendance: {
        subjects: [
            {
                name: "Data Structures",
                percentage: 85,
                classes: [
                    { date: "2025-11-01", status: "present" },
                    { date: "2025-11-08", status: "present" }
                ]
            }
        ]
    }
}
```

#### 3. **Horizontal Scaling** ğŸ“ˆ

-   Easy to add more servers
-   Automatic sharding
-   Better for large datasets

#### 4. **Face Recognition Data** ğŸ‘¤

```javascript
// Store binary face encodings easily
{
    user_id: "uuid",
    face_encodings: [
        [0.123, 0.456, 0.789, ...],  // 128-dimensional array
        [0.321, 0.654, 0.987, ...]   // Another angle
    ],
    images: [
        BinData(0, "base64-encoded-image-data"),
        BinData(0, "base64-encoded-image-data")
    ]
}
```

---

## âš ï¸ The djongo Problem

### Why We Had Issues:

**Django was built for SQL**, so:

-   Django ORM generates SQL queries
-   djongo must convert SQL â†’ MongoDB
-   Sometimes djongo can't parse complex SQL

### Issues We Fixed:

1. **Index Conflicts:**

    ```python
    # ForeignKey creates automatic indexes
    # If also in Meta.indexes, djongo creates duplicate
    # Solution: Add db_constraint=False
    ```

2. **Complex Queries:**

    ```sql
    -- Django generates this for limit_choices_to
    SELECT * FROM users
    WHERE EXISTS (
        SELECT 1 FROM users U0
        WHERE U0.role = 'hod' AND U0.id = users.id
    )
    -- djongo can't parse EXISTS subquery!
    -- Solution: Custom admin forms
    ```

3. **Foreign Key Constraints:**
    ```python
    # MongoDB doesn't have foreign keys
    # But Django expects them
    # Solution: db_constraint=False everywhere
    ```

---

## ğŸ¯ Best Practices

### DO âœ…

1. **Use Django ORM (Not Raw Queries):**

    ```python
    # Good
    User.objects.filter(role='student')

    # Avoid (unless necessary)
    User.objects.raw('SELECT * FROM users WHERE role = "student"')
    ```

2. **Always Add db_constraint=False:**

    ```python
    department = models.ForeignKey(
        Department,
        db_constraint=False  # â† Required for MongoDB!
    )
    ```

3. **Use Simple Queries:**

    ```python
    # Good - djongo can handle
    users = User.objects.filter(role='student', is_active=True)

    # Bad - might break djongo
    users = User.objects.annotate(
        complex_calc=Count('attendance', filter=Q(...))
    )
    ```

### DON'T âŒ

1. **Don't Use limit_choices_to in Models:**

    ```python
    # Bad - causes SQL parsing errors
    hod = models.ForeignKey(
        User,
        limit_choices_to={'role': 'hod'}  # â† Remove this!
    )

    # Good - filter in forms instead
    class MyForm(forms.ModelForm):
        def __init__(self):
            self.fields['hod'].queryset = User.objects.filter(role='hod')
    ```

2. **Don't Use Complex Aggregations:**

    ```python
    # May not work with djongo
    result = User.objects.values('department').annotate(
        avg_attendance=Avg('attendance__percentage'),
        student_count=Count('id', distinct=True)
    ).filter(avg_attendance__lt=75)
    ```

3. **Don't Rely on SQL Features:**
    - No foreign key constraints at DB level
    - No triggers
    - No stored procedures
    - No views

---

## ğŸ”§ Check Your Setup

### Verify MongoDB is Running:

#### PowerShell:

```powershell
# Check MongoDB service
Get-Service -Name "MongoDB"

# Should show: Status = Running

# Connect to MongoDB
mongosh

# Should connect successfully
```

#### View Your Data:

```powershell
# In mongosh
use presenceiq_final
show collections
db.users.countDocuments()
```

### Verify Django Connection:

```python
# In Django shell
python manage.py shell

# Run these commands:
from apps.authentication.models import User
User.objects.count()  # Should return number without errors

from apps.academic.models import Department
Department.objects.all()  # Should work
```

---

## ğŸ“Š Data Flow Example

### Creating a User via Admin:

```
1. Admin Panel Form Submit
   â†“
2. Django Form Validation
   â†“
3. Django ORM: User.objects.create(...)
   â†“
4. Django generates: INSERT INTO users VALUES (...)
   â†“
5. djongo converts: db.users.insertOne({...})
   â†“
6. MongoDB stores document
   â†“
7. Returns ObjectId
   â†“
8. Django converts to UUID
   â†“
9. Admin shows success message
```

---

## ğŸ“ Summary

| Aspect             | Our Setup           |
| ------------------ | ------------------- |
| **Database**       | MongoDB (NoSQL)     |
| **Engine**         | djongo 1.3.6        |
| **ORM**            | Django ORM          |
| **Query Language** | Python (Django ORM) |
| **Storage**        | JSON-like documents |
| **Database Name**  | presenceiq_final    |
| **Collections**    | ~20 collections     |
| **Location**       | localhost:27017     |

### The Stack:

```
Python/Django
    â†“
Django ORM (Generates SQL)
    â†“
djongo (Converts SQL â†’ MongoDB)
    â†“
MongoDB (Stores Documents)
```

### Why It Works:

-   Django thinks it's talking to SQL
-   djongo translates everything
-   MongoDB stores the actual data
-   You write normal Django code!

---

## ğŸš€ Bottom Line

**You're using MongoDB**, not SQL! The "SQL" you see in errors is just Django's internal language that djongo translates to MongoDB commands.

**For you as a developer:**

-   Write Django ORM code (Python)
-   Django handles the translation
-   djongo converts to MongoDB
-   Data lives in MongoDB collections

**You never write SQL or MongoDB queries directly!** ğŸ‰

---

**Database:** MongoDB (NoSQL)  
**Location:** localhost:27017  
**Database Name:** presenceiq_final  
**Collections:** 20+  
**Status:** âœ… Working
